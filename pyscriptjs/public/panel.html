<html><head>
    <title>Bokeh Example</title>
    <meta charset="iso-8859-1">
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-2.4.2.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-gl-2.4.2.min.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-widgets-2.4.2.min.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-tables-2.4.2.min.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-mathjax-2.4.2.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@holoviz/panel@0.13.0-rc.5/dist/panel.min.js"></script>

    <script type="text/javascript">
        Bokeh.set_log_level("info");
    </script>
    <link rel="stylesheet" href="build/pyscript.css" />
    
    <script defer src="build/pyscript.js"></script>
    
    </head>
    <body>
        <py-env>
- bokeh
- numpy
        </py-env>
        <h1>Bokeh Example</h1>
        <div id="myplot"></div>
    
    <py-script>
import json
import pyodide
import asyncio
import micropip

from js import Bokeh, console, JSON

import bokeh

from bokeh.document import Document
from bokeh.embed.util import OutputDocumentFor, standalone_docs_json
from bokeh.protocol.messages.patch_doc import process_document_events

await micropip.install(['panel==0.13.0rc5'])

import panel as pn

def callback(new):
    return f'Amplitude is: {new}'

slider = pn.widgets.FloatSlider(start=0, end=10, name='Amplitude')

row = pn.Row(slider, pn.bind(callback, slider))

print("about to embed")

def doc_json(model, target):
    doc = model.server_doc()
    model = doc.roots[0]
    docs_json = standalone_docs_json([model])

    doc_json = list(docs_json.values())[0]
    root_id = doc_json['roots']['root_ids'][0]

    return doc, json.dumps(dict(
        target_id = target,
        root_id   = root_id,
        doc       = doc_json,
        version   = bokeh.__version__,
    ))

def link_docs(pydoc, jsdoc):
    def jssync(event):
        if (event.setter_id is not None):
            return
        events = [event]
        json_patch = jsdoc.create_json_patch_string(pyodide.to_js(events))
        pydoc.apply_json_patch(json.loads(json_patch))

    jsdoc.on_change(pyodide.create_proxy(jssync), pyodide.to_js(False))

    def pysync(event):
        json_patch = process_document_events([event], use_buffers=False)[0]

        jsdoc.apply_json_patch(JSON.parse(json_patch), {}, setter_id='js')

    pydoc.on_change(pysync)

async def show(plot, target):
    pydoc, model_json = doc_json(plot, target)
    views = await Bokeh.embed.embed_item(JSON.parse(model_json))
    print("Done embedding...")
    jsdoc = views[0].model.document
    link_docs(pydoc, jsdoc)

await show(row, 'myplot')
    </py-script>
    
</body>
</html>
